<app-breadcrumbs [crumbs]="[
  { label: 'System', link: ['/dashboard'] },
  { label: 'Wiadomo≈õci' }
]" />
<div class="bg-white rounded-lg shadow">
  <!-- Header -->
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-gray-900">Wiadomo≈õci</h2>
      
      <div class="flex items-center space-x-3">
        <button 
          (click)="showFilters = !showFilters"
          [class.bg-uknf-primary]="showFilters"
          [class.text-white]="showFilters"
          class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors">
          Filtry
        </button>

        <button 
          *ngIf="isAdmin"
          (click)="composeBulkMessage()"
          class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors">
          Wiadomo≈õƒá masowa
        </button>
        
        <button 
          (click)="composeMessage()"
          class="px-4 py-2 bg-uknf-primary hover:bg-uknf-primary-dark text-white rounded transition-colors">
          Nowa wiadomo≈õƒá
        </button>
      </div>
    </div>
  </div>

  <!-- Panel filtr√≥w -->
  <div *ngIf="showFilters" class="px-6 py-4 bg-gray-50 border-b border-gray-200">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Temat</label>
        <input 
          type="text"
          [(ngModel)]="filter.subject"
          (ngModelChange)="onSearchChange()"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded"
          placeholder="Szukaj...">
      </div>
      
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
        <select 
          [(ngModel)]="filter.status"
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded">
          <option value="">Wszystkie</option>
          <option value="DRAFT">Wersja robocza</option>
          <option value="SENT">Wys≈Çane</option>
          <option value="READ">Przeczytane</option>
          <option value="AWAITING_REPLY">Oczekuje na odpowied≈∫</option>
          <option value="REPLIED">Z odpowiedziƒÖ</option>
          <option value="CLOSED">Zamkniƒôte</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Kategoria</label>
        <select 
          [(ngModel)]="filter.category"
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded">
          <option value="">Wszystkie</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Priorytet</label>
        <select 
          [(ngModel)]="filter.priority"
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded">
          <option value="">Wszystkie</option>
          <option value="LOW">Niski</option>
          <option value="NORMAL">Normalny</option>
          <option value="HIGH">Wysoki</option>
        </select>
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <label class="flex items-center cursor-pointer">
          <input 
            type="checkbox" 
            [(ngModel)]="filter.mySubjectsOnly"
            (ngModelChange)="applyFilters()"
            class="h-4 w-4 text-uknf-primary rounded">
          <span class="ml-2 text-sm text-gray-700">Tylko moje podmioty</span>
        </label>

        <label class="flex items-center cursor-pointer">
          <input 
            type="checkbox" 
            [(ngModel)]="filter.requiresReply"
            (ngModelChange)="applyFilters()"
            class="h-4 w-4 text-uknf-primary rounded">
          <span class="ml-2 text-sm text-gray-700">Wymaga odpowiedzi</span>
        </label>
      </div>

      <button 
        (click)="clearFilters()"
        class="text-sm text-uknf-primary hover:text-uknf-primary-dark font-medium">
        Wyczy≈õƒá filtry
      </button>
    </div>
  </div>

  <!-- Statystyki -->
  <div class="px-6 py-3 bg-blue-50 border-b border-blue-100">
    <div class="flex items-center space-x-6 text-sm">
      <div>
        <span class="text-gray-600">Wszystkie:</span>
        <span class="ml-2 font-semibold text-gray-900">{{ totalElements }}</span>
      </div>
      <div>
        <span class="text-gray-600">Nieprzeczytane:</span>
        <span class="ml-2 font-semibold text-blue-600">{{ unreadCount }}</span>
      </div>
      <div>
        <span class="text-gray-600">Strona:</span>
        <span class="ml-2 font-semibold text-gray-900">{{ currentPage + 1 }} z {{ totalPages || 1 }}</span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-uknf-primary"></div>
    <p class="mt-4 text-gray-600">≈Åadowanie...</p>
  </div>

  <!-- Lista wiadomo≈õci -->
  <div *ngIf="!loading" class="divide-y divide-gray-200">
    <div *ngIf="messages.length === 0" class="text-center py-12 text-gray-500">
      <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      <p class="text-lg font-medium">Brak wiadomo≈õci</p>
    </div>

    <div 
      *ngFor="let message of messages" 
      (click)="viewMessage(message)"
      [class.bg-blue-50]="message.status === 'SENT' || message.status === 'AWAITING_REPLY'"
      class="px-6 py-4 hover:bg-gray-50 cursor-pointer transition-colors">
      <div class="flex justify-between">
        <div class="flex-1">
          <div class="flex items-center space-x-3 mb-1">
            <span 
              [class]="messagesService.getStatusClass(message.status)"
              class="px-2 py-1 text-xs font-medium rounded">
              {{ messagesService.getStatusLabel(message.status) }}
            </span>
            
            <span 
              *ngIf="message.priority === 'HIGH'"
              [class]="messagesService.getPriorityClass(message.priority)"
              class="px-2 py-1 text-xs font-medium rounded">
              {{ messagesService.getPriorityLabel(message.priority) }}
            </span>

            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">
              {{ message.category }}
            </span>

            <span *ngIf="message.attachments && message.attachments.length > 0" class="text-xs text-gray-500">
              üìé {{ message.attachments.length }}
            </span>
          </div>

          <h3 
            [class.font-bold]="message.status === 'SENT' || message.status === 'AWAITING_REPLY'"
            class="text-base text-gray-900 mb-1">
            {{ message.subject }}
          </h3>

          <p class="text-sm text-gray-600 mb-2 line-clamp-2">
            {{ message.content }}
          </p>

          <div class="flex items-center text-xs text-gray-500 space-x-4">
            <span class="flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              {{ message.sender.name }}
            </span>
            <span class="flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              {{ formatDate(message.createdAt) }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paginacja -->
  <div *ngIf="!loading && totalPages > 1" class="px-6 py-4 border-t border-gray-200">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600">
        Wyniki {{ (currentPage * pageSize) + 1 }}-{{ Math.min((currentPage + 1) * pageSize, totalElements) }} z {{ totalElements }}
      </div>
      
      <div class="flex items-center space-x-2">
        <button 
          (click)="previousPage()"
          [disabled]="currentPage === 0"
          [class.opacity-50]="currentPage === 0"
          class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">
          ‚Üê Poprzednia
        </button>

        <button 
          *ngFor="let page of getPageNumbers()"
          (click)="goToPage(page)"
          [class.bg-uknf-primary]="page === currentPage"
          [class.text-white]="page === currentPage"
          [class.bg-gray-100]="page !== currentPage"
          class="px-3 py-1 hover:bg-gray-200 rounded text-sm">
          {{ page + 1 }}
        </button>

        <button 
          (click)="nextPage()"
          [disabled]="currentPage >= totalPages - 1"
          [class.opacity-50]="currentPage >= totalPages - 1"
          class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">
          Nastƒôpna ‚Üí
        </button>
      </div>
    </div>
  </div>
</div>
